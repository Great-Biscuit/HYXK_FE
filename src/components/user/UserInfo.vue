<template>
  <div class="box">
    <div class="above">
      <div class="head">
        <el-row :gutter="20" class="head-el-row">
          <el-col :span="3" v-on:click="this.$router.back()">
            <i class="iconfont">&#xe66a;</i>
          </el-col>
          <el-col :span="18"></el-col>
          <el-col :span="3">
            <i class="iconfont" v-on:click="openActionBox" style="color: #a1c0ff;" v-if="userId === holderUserId">&#xe8b7;</i>
          </el-col>
        </el-row>
      </div>
      <div class="user-info" v-if="userInfo !== null">
        <el-row>
          <el-col :span="8">
            <el-avatar :size="65" :src="userInfo.user.headerUrl" />
          </el-col>
          <el-col :span="5"></el-col>
          <el-col :span="11" style="text-align: center;">
            <!-- Â¶ÇÊûúÊòØÁî®Êà∑Êú¨‰∫∫Â∞±ÊòæÁ§∫[ÁºñËæëËµÑÊñô], Âê¶ÂàôÊòæÁ§∫[ÂÖ≥Ê≥® ÁßÅ‰ø°] -->
            <el-button round class="user-info-button" v-if="userId === holderUserId" @click="this.$router.push('/UpdateUserInfo')">
              <span class="white-bolder-font">ÁºñËæëËµÑÊñô</span>
            </el-button>
            <span v-else>
              <el-button round class="user-info-button">
              <span class="white-bolder-font" @click="this.$router.push(`/chat/${userId}`)">ÁßÅ‰ø°</span>
            </el-button>
            <el-button round class="user-info-button" v-if="userInfo.hasFollow" @click="unFollowUser(null)">
              <span class="white-bolder-font" style="color: #333333b3;">Â∑≤ÂÖ≥Ê≥®</span>
            </el-button>
            <el-button round class="user-info-button" v-else @click="followUser(null)">
              <span class="white-bolder-font">ÂÖ≥Ê≥®</span>
            </el-button>
            </span>
          </el-col>
        </el-row>
        <el-row style="margin: 8px 0px;">
          <el-col :span="16">
            <span class="white-bolder-font" style="font-size: 20px;padding-right: 5px;">{{ userInfo.user.nickname }}</span>
            <!-- 0-Êú™Áü• 1-Áî∑ 2-Â•≥ -->
            <span class="iconfont white-bolder-font" v-if="userInfo.user.gender === 0" style="padding: 3px;border-radius: 50%;background-color: #7a7a7a;">&#xe65e;</span>
            <span class="iconfont white-bolder-font" v-else-if="userInfo.user.gender === 1" style="padding: 3px;border-radius: 50%;background-color: #00a9ff;">&#xe68d;</span>
            <span class="iconfont white-bolder-font" v-else style="padding: 3px;border-radius: 50%;background-color: #fb9b9b;">&#xe68b;</span>
          </el-col>
          <el-col :span="6"></el-col>
        </el-row>
        <div style="margin: 8px 0px;">
          <span class="white-bolder-font">{{ userInfo.user.signature }}</span>
        </div>
        <!-- ÊòæÁ§∫Ë¢´ËµûÊï∞Èáè ÂÖ≥Ê≥®Êï∞ Á≤â‰∏ùÊï∞ -->
        <el-row class="user-number">
          <el-col :span="6">
            <span class="white-bolder-font" style="font-size: 20px;padding-right: 5px;">{{ userInfo.beLikedCount }}</span>
            <span class="white-bolder-font">Ëé∑Ëµû</span>
          </el-col>
          <el-col :span="6" v-on:click="showFollowFun">
            <span class="white-bolder-font" style="font-size: 20px;padding-right: 5px;">{{ userInfo.followCount }}</span>
            <span class="white-bolder-font">ÂÖ≥Ê≥®</span>
          </el-col>
          <el-col :span="6" v-on:click="showFansFun">
            <span class="white-bolder-font" style="font-size: 20px;padding-right: 5px;">{{ userInfo.fansCount }}</span>
            <span class="white-bolder-font">Á≤â‰∏ù</span>
          </el-col>
        </el-row>
      </div>
    </div>
    <div class="under">
      <el-tabs v-model="activeName" class="demo-tabs" :stretch="true">
        <el-tab-pane label="ÂèëÂ∏É" name="userPosts"></el-tab-pane>
        <el-tab-pane label="Êî∂Ëóè" name="collectPosts"></el-tab-pane>
      </el-tabs>
      <div class="postsBox" v-if="userId !== null">
        <UserPosts :userId="userId" v-if="activeName === 'userPosts'" />
        <CollectPosts :userId="userId" v-else />
      </div>
    </div>
    <!-- ÊòæÁ§∫ÂÖ≥Ê≥®ÁöÑ‰∫∫ -->
    <el-drawer
    v-model="showFollowee"
    title="üëØÂÖ≥Ê≥®ÁöÑ‰∫∫"
    :direction="direction" 
    size="100%" 
    :destroy-on-close="true"
    >
      <el-empty description="ËøòÊ≤°ÊúâÂÖ≥Ê≥®TaÂìü~" v-if="followeeList === null || followeeList.length === 0" />
      <div v-else class="fansOrFollowList">
        <el-scrollbar>
          <div v-for="followeeVo in followeeList" :key="followeeVo" class="fansOrFollowItem">
            <el-row style="align-items: center;">
              <el-col :span="4">
                <el-avatar :size="50" :src="followeeVo.user.headerUrl" style="margin: 3px;" />
              </el-col>
              <el-col :span="14" class="fansOrFollowNickname">
                <span class="nickname">{{ followeeVo.user.nickname }}</span>
                <!-- 0-Êú™Áü• 1-Áî∑ 2-Â•≥ -->
                <span class="iconfont white-bolder-font" v-if="followeeVo.user.gender === 0" style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #7a7a7a;">&#xe65e;</span>
                <span class="iconfont white-bolder-font" v-else-if="followeeVo.user.gender === 1" style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #00a9ff;">&#xe68d;</span>
                <span class="iconfont white-bolder-font" v-else style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #fb9b9b;">&#xe68b;</span>
              </el-col>
              <!-- Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑Ëá™Â∑±, Â∞±‰∏çÊòæÁ§∫‰ªª‰ΩïÂÜÖÂÆπ -->
              <el-col :span="6" style="text-align: center;" v-if="holderUserId !== followeeVo.user.id">
                <el-button round class="follow__button" v-if="followeeVo.hasFollowed">
                  <span @click="unFollowUser(followeeVo)">Â∑≤ÂÖ≥Ê≥®</span>
                </el-button>
                <el-button type="primary" round class="follow__button" v-else>
                  <span @click="followUser(followeeVo)">ÂÖ≥Ê≥®</span>
                </el-button>
              </el-col>
            </el-row>
          </div>
        </el-scrollbar>
      </div>
    </el-drawer>
    <!-- ÊòæÁ§∫Á≤â‰∏ù -->
    <el-drawer
    v-model="showFans"
    title="üëØÁ≤â‰∏ù"
    :direction="direction" 
    size="100%" 
    :destroy-on-close="true"
    >
      <el-empty description="ËøòÊ≤°ÊúâÁ≤â‰∏ùÂìü~" v-if="fansList === null || fansList.length === 0" />
      <div v-else class="fansOrFollowList">
        <el-scrollbar>
          <div v-for="fansVo in fansList" :key="fansVo" class="fansOrFollowItem">
            <el-row style="align-items: center;">
              <el-col :span="4">
                <el-avatar :size="50" :src="fansVo.user.headerUrl" style="margin: 3px;" />
              </el-col>
              <el-col :span="14" class="fansOrFollowNickname">
                <span class="nickname">{{ fansVo.user.nickname }}</span>
                <!-- 0-Êú™Áü• 1-Áî∑ 2-Â•≥ -->
                <span class="iconfont white-bolder-font" v-if="fansVo.user.gender === 0" style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #7a7a7a;">&#xe65e;</span>
                <span class="iconfont white-bolder-font" v-else-if="fansVo.user.gender === 1" style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #00a9ff;">&#xe68d;</span>
                <span class="iconfont white-bolder-font" v-else style="position: relative;top: -5px;margin-left: 3px;padding: 3px;border-radius: 50%;background-color: #fb9b9b;">&#xe68b;</span>
              </el-col>
              <!-- Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑Ëá™Â∑±, Â∞±‰∏çÊòæÁ§∫‰ªª‰ΩïÂÜÖÂÆπ -->
              <el-col :span="6" style="text-align: center;" v-if="holderUserId !== fansVo.user.id">
                <el-button round class="follow__button" v-if="fansVo.hasFollowed">
                  <span @click="unFollowUser(fansVo)">Â∑≤ÂÖ≥Ê≥®</span>
                </el-button>
                <el-button type="primary" round class="follow__button" v-else>
                  <span @click="followUser(fansVo)">ÂÖ≥Ê≥®</span>
                </el-button>
              </el-col>
            </el-row>
          </div>
        </el-scrollbar>
      </div>
    </el-drawer>
    <el-drawer
    v-model="drawer"
    :direction="actionBoxDirection" 
    size="150px" 
    :with-header="false"
    >
      <div class="actionBox">
        <div class="actionBoxItem" style="color: #73767a;" @click="toUpdatePassword">‰øÆÊîπÂØÜÁ†Å</div>
        <el-divider />
        <div class="actionBoxItem" style="color: red;" @click="logout">ÈÄÄÂá∫ÁôªÂΩï</div>
      </div>
    </el-drawer>
  </div>
</template>

<script>

import { get, post } from '../../utils/axios'
import { ElNotification } from 'element-plus'
import UserPosts from './UserPosts.vue'
import CollectPosts from './CollectPosts.vue'

export default {
  name: 'UserInfo',
  components: {
    UserPosts,
    CollectPosts
  },
  data () {
    return {
      userId: null,
      userInfo: null,
      holderUserId: null,
      showFollowee: false,
      followeeList: null,
      showFans: false,
      fansList: null,
      direction: "ttb",
      drawer: false,
      actionBoxDirection: "btt",
      activeName: 'userPosts',
    }
  },
  mounted () {
    this.userId = this.$route.params.userId
    this.getUserInfo()
  },
  methods: {
    getUserInfo () {
      get('/user/action/getUserInfo/' + this.userId)
        .then(response => {
          if (response.code === 200) {
            console.log(response)
            this.userInfo = response.data
            this.holderUserId = response.msg
          } else {
            ElNotification({
              title: "ÈîôËØØ: " + response.code,
              message: response.msg,
              type: 'error',
              duration: 2000,
            })
          }
        })
        .catch(() => {
            ElNotification({
              title: "ÈîôËØØ",
              message: "ÂèëÁîüÈîôËØØ!",
              type: 'error',
              duration: 2000,
            })
        })
    },
    showFollowFun () {
      this.showFollowee = true

      let formData = new FormData()
      formData.append('userId', this.userId)
      formData.append('offset', 0)
      formData.append('limit', 1000000) //Êü•ËØ¢1000000‰∏™
      post('/user/follow/followList', formData)
        .then(response => {
          if (response.code === 200) {
            this.followeeList = response.data;
          } else {
            ElNotification({
              title: "ÈîôËØØ: " + response.code,
              message: response.msg,
              type: 'error',
              duration: 2000,
            })
          }
        })
        .catch(() => {
            ElNotification({
              title: "ÈîôËØØ",
              message: "ÂèëÁîüÈîôËØØ!",
              type: 'error',
              duration: 2000,
            })
        })
    },
    showFansFun () {
      this.showFans = true
      
      let formData = new FormData()
      formData.append('userId', this.userId)
      formData.append('offset', 0)
      formData.append('limit', 1000000) //Êü•ËØ¢1000000‰∏™
      post('/user/follow/fansList', formData)
        .then(response => {
          if (response.code === 200) {
            this.fansList = response.data;
          } else {
            ElNotification({
              title: "ÈîôËØØ: " + response.code,
              message: response.msg,
              type: 'error',
              duration: 2000,
            })
          }
        })
        .catch(() => {
            ElNotification({
              title: "ÈîôËØØ",
              message: "ÂèëÁîüÈîôËØØ!",
              type: 'error',
              duration: 2000,
            })
        })
    },
    openActionBox () {
      // ÊâìÂºÄÊìç‰ΩúÊ°Ü
      this.drawer = true
    },
    toUpdatePassword () {
      // ÂÖ≥Èó≠Êìç‰ΩúÊ°Ü
      this.drawer = false
      console.log("‰øÆÊîπÂØÜÁ†Å")
    },
    logout () {
      post('/user/login/loginOut')
        .then(response => {
          if (response.code === 200) {
            ElNotification({
              title: "ÊàêÂäü",
              message: "ÈÄÄÂá∫ÁôªÂΩï",
              type: 'success',
              duration: 2000,
            })
            // replaceÂà∞È¶ñÈ°µ
            this.$router.replace({path: '/Home'})
          } else {
            ElNotification({
              title: "ÈîôËØØ: " + response.code,
              message: response.msg,
              type: 'error',
              duration: 2000,
            })
          }
        })
        .catch(() => {
            ElNotification({
              title: "ÈîôËØØ",
              message: "ÂèëÁîüÈîôËØØ!",
              type: 'error',
              duration: 2000,
            })
        })
    },
    // ÂèñÊ∂àÂÖ≥Ê≥®
    unFollowUser (entityVo) {
      if (entityVo === null) {
        // ‰∏∫Á©∫Âàô‰∏∫ÂØπÂΩìÂâçÁî®Êà∑È°µÊòæÁ§∫ÁöÑÁî®Êà∑ÁöÑÊìç‰Ωú
        this.userInfo.hasFollow = false
      } else {
        // ‰∏ç‰∏∫Á©∫Âàô‰∏∫ÂØπÂÖ≥Ê≥®ÊàñÁ≤â‰∏ùÂàóË°®‰∏≠ÁöÑÁî®Êà∑ÁöÑÊìç‰Ωú
        entityVo.hasFollowed = false
      }
    },
    // ÂÖ≥Ê≥®
    followUser (entityVo) {
      if (entityVo === null) {
        // ‰∏∫Á©∫Âàô‰∏∫ÂØπÂΩìÂâçÁî®Êà∑È°µÊòæÁ§∫ÁöÑÁî®Êà∑ÁöÑÊìç‰Ωú
        this.userInfo.hasFollow = true
      } else {
        // ‰∏ç‰∏∫Á©∫Âàô‰∏∫ÂØπÂÖ≥Ê≥®ÊàñÁ≤â‰∏ùÂàóË°®‰∏≠ÁöÑÁî®Êà∑ÁöÑÊìç‰Ωú
        entityVo.hasFollowed = true
      }
    }
  }
}
</script>

<style scoped>
.box {
	width:100vw;
	height:100vh;
  margin: -8px;
}
.above {
  height: 35%;
  background: url('https://ae01.alicdn.com/kf/H1e0faa96b30446e4a43e4e59d1444628o.jpg') no-repeat;
  background-size: 100% 100%;
  position: relative;
}
.under {
  height: 65%;
}
.head {
  height: 15%;
}
.head-el-row {
  text-align: center;
  padding: 10px 15px;
  margin: 0!important;
}
.iconfont {
  font-size: 25px;
}
.user-info {
  padding: 10px;
  padding-top: 30px;
}
.user-info-button {
  margin-top: 20px;
  padding: 15px!important;
  background: #626262cf;
}
:deep(.el-button:hover){
  color: white;
  background-color: #626262cf;
}
.white-bolder-font {
  font-family:Èªë‰Ωì;
  font-size: 16px;
  font-weight:bolder;
  color: white;
  white-space: nowrap;  /*ÈôêÂà∂‰∏ÄË°åÂÜÖÊòæÁ§∫ÊñáÊú¨*/
  overflow: hidden;     /*ÈöêËóèË∂ÖÂá∫ÁöÑÈÉ®ÂàÜ*/
  text-overflow: ellipsis;  /*Ë∂ÖÂá∫ÁöÑÈÉ®ÂàÜÁî®ÁúÅÁï•Âè∑Êõø‰ª£*/
  width: 100%;
}
.user-number {
  position: absolute;
  bottom: 9px;
  width: 90%;
}
.fansOrFollowList {
  height: 100%;
  width: 100%;
}
:deep(.el-drawer__body) {
  padding: 0;
}
.fansOrFollowNickname {
  font-family:Èªë‰Ωì;
  font-size: 20px;
  font-weight:bolder;
  width: 100%;
}
.nickname{
  display: inline-block;
  max-width: 89%;
  white-space: nowrap;  /*ÈôêÂà∂‰∏ÄË°åÂÜÖÊòæÁ§∫ÊñáÊú¨*/
  overflow: hidden;     /*ÈöêËóèË∂ÖÂá∫ÁöÑÈÉ®ÂàÜ*/
  text-overflow: ellipsis;  /*Ë∂ÖÂá∫ÁöÑÈÉ®ÂàÜÁî®ÁúÅÁï•Âè∑Êõø‰ª£*/
}
.fansOrFollowItem {
  height: 60px;
}
.actionBox {
  text-align: center;
}
.actionBoxItem {
  font-family:Èªë‰Ωì;
  font-size: 20px;
  font-weight:bolder;
  margin: 25px;
}
.demo-tabs {
  height: 40px;
}
.postsBox {
  height: calc(100% - 40px);
}
:deep(.el-tabs__item.is-active) {
  color: #dca445;
}
:deep(.el-tabs__active-bar) {
  background-color: #dca445;
}
.follow__button{
  width: 65px;
  height: 32px;
  font-family:Èªë‰Ωì;
  font-size: 16px;
  font-weight:bolder;
}
</style>
